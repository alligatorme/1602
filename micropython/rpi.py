!/usr/bin/python3
import serial,time
nova={
'sleep':	([0xaa,0xb4,0x06,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xff,0xff,0x05,0xab],[0xaa,0xc5,0x06,0x01,0x00,0x00,0xb4,0x6f,0x2a,0xab]),
'wakeup':	([0xaa,0xb4,0x06,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xff,0xff,0x06,0xab],[0xaa,0xc5,0x06,0x01,0x01,0x00,0xb4,0x6f,0x2b,0xab]),
'passive':	([0xaa,0xb4,0x02,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xff,0xff,0x02,0xab],[0xaa,0xc5,0x02,0x01,0x01,0x00,0xb4,0x6f,0x27,0xab]),
'active':	([0xaa,0xb4,0x02,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xff,0xff,0x01,0xab],[0xaa,0xc5,0x02,0x01,0x00,0x00,0xb4,0x6f,0x26,0xab])
}
urt=serial.Serial('/dev/ttyS0',baudrate=9600,parity='N',stopbits=1,rtscts=0,timeout=2)
#print(urt.isOpen())
def get_data(cnt):
	pm25=pm10=i=0
	rsp=b''
	urt.reset_input_buffer()
	while i<cnt:
		rsp+=urt.read(10)
#		print(i,rsp)
		while len(rsp)>=10:
			if rsp[0]==170 and rsp[1]==192 and rsp[9]==171:
				if sum(rsp[2:8])%256==rsp[8]:
					pm25+=(rsp[3]<<8)+rsp[2]
					pm10+=(rsp[5]<<8)+rsp[4]
					i+=1
				rsp=rsp[10:]
			else:
				rsp=rsp[1:]
	return pm25/(10*cnt),pm10/(10*cnt)

def send_cmd(cmd):
	i=0
	rsp=b''
	urt.reset_input_buffer()
	urt.write(bytes(nova[cmd][0]))
	while i<5:
		rsp+=urt.read(10)
		i+=1
#		print(i,rsp)
		while len(rsp)>=10:
			if rsp[0]==170 and rsp[1]==197 and rsp[9]==171 and sum(rsp[2:8])%256==rsp[8]:
				if bytes(rsp[:10])==bytes(nova[cmd][1]):
					return True
				else:
					rsp=rsp[10:]
			else:
				rsp=rsp[1:]
	return False
send_cmd('wakeup')
rst=send_cmd('active')
while not rst:
	rst=send_cmd('active')
time.sleep(30)
print(time.strftime("%Y-%m-%d %H:%M:%S", time.localtime()),get_data(5))
rst=send_cmd('sleep')
while not rst:
	rst=send_cmd('sleep')
